apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: minio
    app.kubernetes.io/name: gitlab
    app.kubernetes.io/version: RELEASE.2017-12-28T01-21-00Z
    chart: minio-0.4.3
    heritage: Helm
    release: gitlab
  name: gitlab-minio
  namespace: gitlab
spec:
  selector:
    matchLabels:
      app: minio
      component: app
      release: gitlab
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: minio
        app.kubernetes.io/name: gitlab
        app.kubernetes.io/version: RELEASE.2017-12-28T01-21-00Z
        chart: minio-0.4.3
        component: app
        heritage: Helm
        release: gitlab
      name: gitlab-minio
    spec:
      automountServiceAccountToken: false
      containers:
        - args:
            - -C
            - /tmp/.minio
            - --quiet
            - server
            - /export
          env:
            - name: TZ
              value: UTC
          image: registry.gitlab.com/gitlab-org/cloud-native/mirror/images/minio/minio:RELEASE.2017-12-28T01-21-00Z
          livenessProbe:
            tcpSocket:
              port: 9000
            timeoutSeconds: 1
          name: minio
          ports:
            - containerPort: 9000
              name: service
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: 1000
          volumeMounts:
            - mountPath: /export
              name: export
            - mountPath: /tmp/.minio
              name: minio-server-config
            - mountPath: /podinfo
              name: podinfo
              readOnly: false
      initContainers:
        - command:
            - sh
            - /config/configure
          env:
            - name: TZ
              value: UTC
          image: registry.gitlab.com/gitlab-org/build/cng/gitlab-base:v18.8.2
          name: configure
          resources:
            requests:
              cpu: 50m
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
          volumeMounts:
            - mountPath: /config
              name: minio-configuration
            - mountPath: /minio
              name: minio-server-config
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault
      volumes:
        - downwardAPI:
            items:
              - fieldRef:
                  fieldPath: metadata.labels
                path: labels
          name: podinfo
        - name: export
          persistentVolumeClaim:
            claimName: gitlab-minio
        - name: minio-configuration
          projected:
            sources:
              - configMap:
                  name: gitlab-minio-config-cm
              - secret:
                  name: gitlab-minio-secret
        - emptyDir:
            medium: Memory
          name: minio-server-config
