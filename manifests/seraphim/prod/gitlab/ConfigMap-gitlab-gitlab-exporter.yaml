apiVersion: v1
data:
  configure: |
    # BEGIN gitlab.scripts.configure.secrets
    set -e
    config_dir="/init-config"
    secret_dir="/init-secrets"
    # optional
    for secret in redis redis-sentinel postgres gitlab-exporter ; do
      if [ -e "${config_dir}/${secret}" ]; then
        mkdir -p "${secret_dir}/${secret}"
        cp -f -v -r -L "${config_dir}/${secret}/." "${secret_dir}/${secret}/"
      fi
    done
    # END gitlab.scripts.configure.secrets
  gitlab-exporter.yml.erb: "server:\n  name: webrick\n  listen_address: \"*\"\n  listen_port: 9168\n  \n\nprobes:\n  db_common: &db_common\n    methods:\n      - probe_db\n    opts:\n      connection_string: dbname=app user=app host=gitlab-pg-rw port=5432 password='<%= File.read('/etc/gitlab/postgres/psql-password-main').strip.gsub(/[\\'\\\\]/) { |esc| '\\\\' + esc } %>'\n  database:\n    multiple: true\n    ci_builds:\n      class_name: Database::CiBuildsProber\n      <<: *db_common\n    tuple_stats:\n      class_name: Database::TuplesProber\n      <<: *db_common\n    rows_count:\n      class_name: Database::RowCountProber\n      <<: *db_common\n  database_bloat:\n    class_name: Database::BloatProber\n    <<: *db_common\n\n  sidekiq: &sidekiq\n    methods:\n      - probe_queues\n      - probe_workers\n      - probe_retries\n      - probe_stats\n    opts:\n      redis_url: redis://:<%= ERB::Util::url_encode(File.read(\"/etc/gitlab/redis/redis-password\").strip) %>@gitlab-vk:6379/0\n      redis_enable_client: false\n      probe_non_namespaced: true\n\n  ruby: &ruby\n    methods:\n      - probe_gc\n    opts:\n      quantiles: false\n\n  metrics:\n    multiple: true\n    ruby:\n      <<: *ruby\n    sidekiq:\n      <<: *sidekiq\n    ci_builds:\n      class_name: Database::CiBuildsProber\n      <<: *db_common\n    tuple_stats:\n      class_name: Database::TuplesProber\n      <<: *db_common\n    rows_count:\n      class_name: Database::RowCountProber\n      <<: *db_common\n    pg_sequences:\n      class_name: Database::PgSequencesProber\n      <<: *db_common\n"
kind: ConfigMap
metadata:
  labels:
    app: gitlab-exporter
    chart: gitlab-exporter-9.8.2
    heritage: Helm
    release: gitlab
  name: gitlab-gitlab-exporter
  namespace: gitlab
