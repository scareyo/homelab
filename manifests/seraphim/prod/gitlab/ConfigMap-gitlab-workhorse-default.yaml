apiVersion: v1
data:
  configure: |
    set -e
    mkdir -p /init-secrets-workhorse/gitlab-workhorse
    cp -v -r -L /init-config/gitlab-workhorse/secret /init-secrets-workhorse/gitlab-workhorse/secret
    mkdir -p /init-secrets-workhorse/redis
    cp -v -r -L /init-config/redis/redis-password /init-secrets-workhorse/redis/
    if [ -d /init-config/minio ]; then
      mkdir -p /init-secrets-workhorse/minio
      cp -v -r -L /init-config/minio/* /init-secrets-workhorse/minio/
    fi
  installation_type: |
    gitlab-helm-chart
  workhorse-config.toml.tpl: |
    shutdown_timeout = "61s"
    [redis]
    DB = 0
    URL = "redis://gitlab-vk:6379"
    Password = {% file.Read "/etc/gitlab/redis/redis-password" | strings.TrimSpace | data.ToJSON %}
    {%- $supported_providers := slice "AWS" "AzureRM" "Google" -%}
    {%- $connection := coll.Dict "provider" "" -%}
    {%- if file.Exists "/etc/gitlab/minio/accesskey" %}
      {%- $aws_access_key_id := file.Read "/etc/gitlab/minio/accesskey" | strings.TrimSpace -%}
      {%- $aws_secret_access_key := file.Read "/etc/gitlab/minio/secretkey" | strings.TrimSpace -%}
      {%- $connection = coll.Dict "provider" "AWS" "aws_access_key_id" $aws_access_key_id "aws_secret_access_key" $aws_secret_access_key -%}
    {%- end %}
    {%- if file.Exists "/etc/gitlab/objectstorage/object_store" %}
      {%- $connection = file.Read "/etc/gitlab/objectstorage/object_store" | strings.TrimSpace | data.YAML -%}
    {%- end %}
    {%- if has $supported_providers $connection.provider %}
    [object_storage]
    provider = "{% $connection.provider %}"
    {%-   if eq $connection.provider "AWS" %}
    {%-     $connection = coll.Merge $connection (coll.Dict "aws_access_key_id" "" "aws_secret_access_key" "" ) %}
    # AWS / S3 object storage configuration.
    [object_storage.s3]
    # access/secret can be blank!
    aws_access_key_id = {% $connection.aws_access_key_id | strings.TrimSpace | data.ToJSON %}
    aws_secret_access_key = {% $connection.aws_secret_access_key | strings.TrimSpace | data.ToJSON %}
    {%-   else if eq $connection.provider "AzureRM" %}
    {%-     $connection = coll.Merge $connection (coll.Dict "azure_storage_account_name" "" "azure_storage_access_key" "") %}
    # Azure Blob storage configuration.
    [object_storage.azurerm]
    azure_storage_account_name = {% $connection.azure_storage_account_name | strings.TrimSpace | data.ToJSON %}
    azure_storage_access_key = {% $connection.azure_storage_access_key | strings.TrimSpace | data.ToJSON %}
    {%-   else if eq $connection.provider "Google" %}
    # Google storage configuration.
    [object_storage.google]
    {% $connection | coll.Omit "provider" | data.ToTOML %}
    {%-   end %}
    {%- end %}
    [image_resizer]
    max_scaler_procs = 2
    max_filesize = 250000
    [[listeners]]
    network = "tcp"
    addr = ":8181"
kind: ConfigMap
metadata:
  labels:
    app: webservice
    chart: webservice-9.8.2
    heritage: Helm
    release: gitlab
  name: gitlab-workhorse-default
  namespace: gitlab
