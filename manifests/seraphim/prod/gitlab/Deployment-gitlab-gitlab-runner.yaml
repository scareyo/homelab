apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: gitlab-gitlab-runner
    chart: gitlab-runner-0.84.2
    heritage: Helm
    release: gitlab
  name: gitlab-gitlab-runner
  namespace: gitlab
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: gitlab-gitlab-runner
  template:
    metadata:
      annotations:
        checksum/configmap: 905c6bf66bc20bed6bd6fb789f8929a0cf1bc73b064c6c00e86f810f6ad6c7eb
        checksum/secrets: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
        gitlab.com/prometheus_port: "9252"
        gitlab.com/prometheus_scrape: "true"
      labels:
        app: gitlab-gitlab-runner
        chart: gitlab-runner-0.84.2
        heritage: Helm
        release: gitlab
    spec:
      containers:
        - command:
            - /usr/bin/dumb-init
            - --
            - /bin/bash
            - /configmaps/entrypoint
          env:
            - name: CI_SERVER_URL
              value: https://gitlab.vegapunk.cloud
            - name: RUNNER_EXECUTOR
              value: kubernetes
            - name: REGISTER_LOCKED
              value: "false"
            - name: RUNNER_TAG_LIST
              value: ""
            - name: KUBERNETES_NAMESPACE
              value: gitlab
            - name: SESSION_SERVER_ADDRESS
          image: registry.gitlab.com/gitlab-org/gitlab-runner:alpine-v18.7.2
          imagePullPolicy: IfNotPresent
          lifecycle:
            preStop:
              exec:
                command:
                  - /entrypoint
                  - unregister
                  - --all-runners
          livenessProbe:
            exec:
              command:
                - /bin/bash
                - /configmaps/check-live
                - "3"
            failureThreshold: 3
            initialDelaySeconds: 60
            periodSeconds: 60
            successThreshold: 1
            timeoutSeconds: 4
          name: gitlab-gitlab-runner
          ports:
            - containerPort: 9252
              name: metrics
          readinessProbe:
            exec:
              command:
                - /usr/bin/pgrep
                - gitlab.*runner
            failureThreshold: 3
            initialDelaySeconds: 60
            periodSeconds: 60
            successThreshold: 1
            timeoutSeconds: 4
          resources: {}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
          volumeMounts:
            - mountPath: /secrets
              name: projected-secrets
            - mountPath: /home/gitlab-runner/.gitlab-runner
              name: etc-gitlab-runner
            - mountPath: /configmaps
              name: configmaps
      securityContext:
        fsGroup: 65533
        runAsUser: 100
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: gitlab-gitlab-runner
      terminationGracePeriodSeconds: 3600
      volumes:
        - emptyDir:
            medium: Memory
          name: runner-secrets
        - emptyDir:
            medium: Memory
          name: etc-gitlab-runner
        - name: projected-secrets
          projected:
            sources:
              - secret:
                  name: gitlab-minio-secret
              - secret:
                  items:
                    - key: runner-registration-token
                      path: runner-registration-token
                    - key: runner-token
                      path: runner-token
                  name: gitlab-gitlab-runner-secret
        - configMap:
            name: gitlab-gitlab-runner
          name: configmaps
