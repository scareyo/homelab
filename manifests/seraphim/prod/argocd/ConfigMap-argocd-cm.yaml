apiVersion: v1
data:
  accounts.readonly: apiKey
  admin.enabled: "true"
  application.instanceLabelKey: argocd.argoproj.io/instance
  application.sync.impersonation.enabled: "false"
  exec.enabled: "false"
  oidc.config: |
    name: SSO
    issuer: https://id.vegapunk.cloud
    clientID: $oauth_client_id
    clientSecret: $oauth_client_secret
    requestedScopes: ["openid", "profile", "email", "groups"]
  resource.customizations.health.ceph.rook.io_CephCluster: |
    local hs = {
        status = "Progressing",
        message = ""
    }

    function append_to_message(message)
        if message ~= "" then
            if hs.message ~= "" then
                hs.message = hs.message .. " - " .. message
            else
                hs.message = message
            end
        end
    end

    if obj.status == nil then
        append_to_message("Waiting for status to be reported")
        return hs
    end

    -- Check the main Ceph health status first - https://github.com/ceph/ceph/blob/v20.3.0/src/include/health.h#L12
    if obj.status.ceph ~= nil and obj.status.ceph.health ~= nil then
        local ceph_health = obj.status.ceph.health
        local details_message = ""

        -- Build details message from status.ceph.details if available
        if obj.status.ceph.details ~= nil then
            local detail_parts = {}
            for detail_type, detail_info in pairs(obj.status.ceph.details) do
                if detail_info.message ~= nil then
                    table.insert(detail_parts, detail_info.message)
                end
            end
            if #detail_parts > 0 then
                details_message =  " (" .. table.concat(detail_parts, "; ") .. ")"
            end
        end

        if ceph_health == "HEALTH_ERR" or ceph_health == "HEALTH_WARN" then
            hs.status = "Degraded"
        elseif ceph_health == "HEALTH_OK" then
            hs.status = "Healthy"
        end
        append_to_message("Ceph health is " .. ceph_health .. details_message)
    end

    -- Check state - https://github.com/rook/rook/blob/v1.17.7/pkg/apis/ceph.rook.io/v1/types.go#L621
    if obj.status.state ~= nil then
        if hs.status == "Healthy" then
            append_to_message("Ceph cluster state is " .. obj.status.state)
            if obj.status.state == "Created" or obj.status.state == "Connected" then
                hs.status = "Healthy"
            elseif obj.status.state == "Error" then
                hs.status = "Degraded"
            else
                hs.status = "Progressing"
            end
        end
    end

    if obj.status.message ~= nil then
        append_to_message(obj.status.message)
    end

    return hs
  resource.customizations.health.ceph.rook.io_CephObjectStore: |
    local hs = {
        status = "Progressing",
        message = "Waiting for status to be reported"
    }

    if obj.status == nil then
        return hs
    end

    -- phase status check - https://github.com/rook/rook/blob/v1.17.7/pkg/apis/ceph.rook.io/v1/types.go#L596
    if obj.status.phase ~= nil then
        hs.message = "Ceph object store phase is " .. obj.status.phase
        if obj.status.phase == "Ready" then
            hs.status = "Healthy"
        elseif obj.status.phase == "Failure" then
            hs.status = "Degraded"
        end
    end

    if obj.status.info ~= nil and obj.status.info.endpoint ~= nil and obj.status.info.endpoint ~= "" then
        hs.message = hs.message .. " - endpoint: " .. obj.status.info.endpoint
    end

    return hs
  resource.customizations.health.objectbucket.io_ObjectBucketClaim: |
    local hs = {
        status = "Progressing",
        message = "Waiting for status to be reported"
    }

    -- phase status check - https://github.com/kube-object-storage/lib-bucket-provisioner/blob/ffa47d5/pkg/apis/objectbucket.io/v1alpha1/objectbucketclaim_types.go#L58
    if obj.status ~= nil then
        if obj.status.phase ~= nil then
            hs.message = "Object bucket claim phase is " .. obj.status.phase
            if obj.status.phase == "Bound" then
                hs.status = "Healthy"
            elseif obj.status.phase == "Failed" then
                hs.status = "Degraded"
            end
        else
            hs.message = "Waiting for phase to be reported"
        end
    end

    return hs
  resource.customizations.ignoreResourceUpdates.ConfigMap: |
    jqPathExpressions:
      # Ignore the cluster-autoscaler status
      - '.metadata.annotations."cluster-autoscaler.kubernetes.io/last-updated"'
      # Ignore the annotation of the legacy Leases election
      - '.metadata.annotations."control-plane.alpha.kubernetes.io/leader"'
  resource.customizations.ignoreResourceUpdates.Endpoints: |
    jsonPointers:
      - /metadata
      - /subsets
  resource.customizations.ignoreResourceUpdates.all: |
    jsonPointers:
      - /status
  resource.customizations.ignoreResourceUpdates.apps_ReplicaSet: |
    jqPathExpressions:
      - '.metadata.annotations."deployment.kubernetes.io/desired-replicas"'
      - '.metadata.annotations."deployment.kubernetes.io/max-replicas"'
      - '.metadata.annotations."rollout.argoproj.io/desired-replicas"'
  resource.customizations.ignoreResourceUpdates.argoproj.io_Application: |
    jqPathExpressions:
      - '.metadata.annotations."notified.notifications.argoproj.io"'
      - '.metadata.annotations."argocd.argoproj.io/refresh"'
      - '.metadata.annotations."argocd.argoproj.io/hydrate"'
      - '.operation'
  resource.customizations.ignoreResourceUpdates.argoproj.io_Rollout: |
    jqPathExpressions:
      - '.metadata.annotations."notified.notifications.argoproj.io"'
  resource.customizations.ignoreResourceUpdates.autoscaling_HorizontalPodAutoscaler: |
    jqPathExpressions:
      - '.metadata.annotations."autoscaling.alpha.kubernetes.io/behavior"'
      - '.metadata.annotations."autoscaling.alpha.kubernetes.io/conditions"'
      - '.metadata.annotations."autoscaling.alpha.kubernetes.io/metrics"'
      - '.metadata.annotations."autoscaling.alpha.kubernetes.io/current-metrics"'
  resource.customizations.ignoreResourceUpdates.discovery.k8s.io_EndpointSlice: |
    jsonPointers:
      - /metadata
      - /endpoints
      - /ports
  resource.exclusions: |
    - apiGroups:
      - "velero.io"
      kinds:
      - Backup
      clusters:
      - "*"
  statusbadge.enabled: "false"
  timeout.hard.reconciliation: 0s
  timeout.reconciliation: 180s
  url: https://argocd.vegapunk.cloud
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/instance: argocd
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
    app.kubernetes.io/version: v3.2.6
    helm.sh/chart: argo-cd-9.3.7
  name: argocd-cm
  namespace: argocd
