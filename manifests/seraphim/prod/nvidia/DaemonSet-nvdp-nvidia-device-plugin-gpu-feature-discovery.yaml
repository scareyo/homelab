apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app.kubernetes.io/instance: nvdp
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: nvidia-device-plugin
    app.kubernetes.io/version: 0.18.2
    helm.sh/chart: nvidia-device-plugin-0.18.2
  name: nvdp-nvidia-device-plugin-gpu-feature-discovery
  namespace: nvidia
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: nvdp
      app.kubernetes.io/name: nvidia-device-plugin
  template:
    metadata:
      annotations: {}
      labels:
        app.kubernetes.io/instance: nvdp
        app.kubernetes.io/name: nvidia-device-plugin
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: feature.node.kubernetes.io/pci-10de.present
                    operator: In
                    values:
                      - "true"
              - matchExpressions:
                  - key: feature.node.kubernetes.io/cpu-model.vendor_id
                    operator: In
                    values:
                      - NVIDIA
              - matchExpressions:
                  - key: nvidia.com/gpu.present
                    operator: In
                    values:
                      - "true"
      containers:
        - command:
            - gpu-feature-discovery
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: GFD_USE_NODE_FEATURE_API
              value: "false"
          image: nvcr.io/nvidia/k8s-device-plugin:v0.18.2
          imagePullPolicy: IfNotPresent
          name: gpu-feature-discovery-ctr
          securityContext:
            privileged: true
          volumeMounts:
            - mountPath: /etc/kubernetes/node-feature-discovery/features.d
              name: output-dir
            - mountPath: /sys
              name: host-sys
            - mountPath: /config
              name: config
      priorityClassName: system-node-critical
      runtimeClassName: nvidia
      securityContext: {}
      tolerations:
        - key: CriticalAddonsOnly
          operator: Exists
        - effect: NoSchedule
          key: nvidia.com/gpu
          operator: Exists
      volumes:
        - hostPath:
            path: /etc/kubernetes/node-feature-discovery/features.d
            type: DirectoryOrCreate
          name: output-dir
        - hostPath:
            path: /sys
            type: Directory
          name: host-sys
        - hostPath:
            path: /
            type: Directory
          name: driver-root
        - emptyDir: {}
          name: config
  updateStrategy:
    type: RollingUpdate
